{% load static %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>BNI Traffic Light Dashboard</title>
  <style>
    body { font-family: "Segoe UI", Arial, sans-serif; background:#f6f6f6; padding:20px; color:#222; }
    .container { max-width:1200px; margin:0 auto; }

    .header-row { display:flex; gap:12px; margin-bottom:14px; }
    .hdr { flex:1; background:#b22222; color:white; padding:10px; text-align:center; font-weight:700; border-radius:4px; }
    .panel { background:white; padding:10px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.06); }

    .top-row { display:flex; gap:12px; margin-bottom:12px; }
    .left, .right { width:250px; }
    .middle { flex:1; }

    .small-title { font-size:13px; font-weight:700; margin-bottom:6px; color:#444; }
    .mini-table { width:100%; border-collapse:collapse; font-size:13px; }
    .mini-table th, .mini-table td { padding:6px; border:1px solid #eee; text-align:left; }
    .mini-table th { background:#f3f3f3; }

    /* heatmap table */
    .heat { width:100%; border-collapse:collapse; font-size:13px; }
    .heat th, .heat td { padding:8px; border:1px solid #ddd; text-align:center; }
    .heat th { background:#b22222; color:white; position:sticky; top:0; z-index:2; }

    .GREEN { background:#d4edda; color:#155724; font-weight:600; }
    .AMBER { background:#fff3cd; color:#856404; font-weight:600; }
    .RED { background:#f8d7da; color:#721c24; font-weight:600; }
    .GREY { background:#e9ecef; color:#6c757d; }

    .member-name { text-align:left; padding-left:10px; font-weight:600; }

    .footer { margin-top:14px; }
    .dist-table { width:400px; border-collapse:collapse; }
    .dist-table th, .dist-table td { padding:6px; border:1px solid #e9e9e9; text-align:center; }
    .dist-table th { background:#f3f3f3; }

    /* responsive */
    @media (max-width:900px){
      .top-row { flex-direction:column; }
      .left, .right { width:100%; }
      .header-row { flex-direction:column; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-row">
      <div class="hdr">{{ region }}</div>
      <div class="hdr">{{ chapter }}</div>

<div class="hdr">
  {% if report_month %}
    {{ report_month }}
  {% else %}
    &nbsp;
  {% endif %}
</div>
    </div>

    <form method="post" enctype="multipart/form-data" class="panel" style="margin-bottom:12px;">
      {% csrf_token %}
      <input type="file" name="file" accept=".xls,.xlsx" required>
      <button type="submit" style="margin-left:10px;padding:8px 12px;">Upload & Generate</button>
      {% if error %}
        <div style="color:#b00020;margin-top:8px;">{{ error }}</div>
      {% endif %}
    </form>

    {% if members %}
    <div class="top-row">
      <div class="left panel">
        <div class="small-title">Average Per Member (Top)</div>
        <table class="mini-table">
          <tr><th>Member</th><th>Avg</th></tr>
          {% for m in top_avg_members %}
            <tr>
              <td>{{ m.name }}</td>
<td>
  {% if m.average %}
    {{ m.average }}
  {% else %}
    -
  {% endif %}
</td>
            </tr>
          {% endfor %}
        </table>
      </div>

      <div class="middle panel">
        <div class="small-title">Monthly Heatmap</div>
        <table class="heat">
          <thead>
            <tr>
              <th style="min-width:220px;">Member</th>
              {% for m in months %}
                <th>{{ m }}</th>
              {% endfor %}
              <th>Average</th>
            </tr>
          </thead>
          <tbody>
            {% for mem in members %}
              <tr>
                <td class="member-name">{{ mem.name }}</td>
                {% for cell in mem.per_month %}
                  <td class="{{ cell.color }}">{{ cell.score if cell.score is not None else '-' }}</td>
                {% endfor %}
                <td>{{ mem.average if mem.average is not None else '-' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="right panel">
        <div class="small-title">Current Month Ranking</div>
        <table class="mini-table">
          <tr><th>Member</th><th>Score</th></tr>
          {% for m in current_ranked %}
            <tr>
              <td>{{ m.name }}</td>
              <td style="text-align:center;">{{ m.current_score if m.current_score is not None else '-' }}</td>
            </tr>
          {% endfor %}
        </table>
      </div>
    </div>

    <div class="panel footer">
      <div class="small-title">Monthly Distribution (%)</div>
      <table class="dist-table">
        <tr>
          <th>Month</th>
          <th>Green</th>
          <th>Amber</th>
          <th>Red</th>
          <th>Grey</th>
        </tr>
        {% for m in months %}
          <tr>
            <td>{{ m }}</td>
            <td>{{ distribution[m].GREEN }}%</td>
            <td>{{ distribution[m].AMBER }}%</td>
            <td>{{ distribution[m].RED }}%</td>
            <td>{{ distribution[m].GREY }}%</td>
          </tr>
        {% endfor %}
      </table>
    </div>
    {% endif %}
  </div>
</body>
</html>
