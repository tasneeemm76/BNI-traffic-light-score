<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BNI Reports Summary</title>
    <style>
        body {
            font-family: "Segoe UI", Arial, sans-serif;
            margin: 40px;
            background: #fff;
            color: #333;
        }
        h1, h2, h3 {
            text-align: center;
            margin-bottom: 10px;
        }
        table {
            width: 90%;
            border-collapse: collapse;
            margin: 20px auto;
            text-align: center;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
        }
        th {
            background-color: #f5f5f5;
        }
        .GREEN { background-color: #4CAF50; color: white; }
        .AMBER { background-color: #FFC107; color: black; }
        .RED { background-color: #F44336; color: white; }
        .GREY { background-color: #9E9E9E; color: white; }
        .legend, .averages {
            width: 60%;
        }
        .legend td, .averages td {
            text-align: center;
        }
    </style>
</head>
<body>

    <h1>BNI Members Summary</h1>
    <h3>{{ chapter_name }} | {{ region_name }}</h3>
    <p style="text-align:center;">Period: {{ period_label }}</p>

    <!-- 1️⃣ Main Table: Member Scores (by Month) -->
    <table>
        <thead>
            <tr>
                <th>Member</th>
                {% for m in monthly_scores %}
                    <th>{{ m.month }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% comment %}
            Build a member list dynamically based on the first month’s data
            {% endcomment %}
            {% if monthly_scores %}
                {% for member_row in monthly_scores.0.scores %}
                    {% with member_name=member_row.member %}
                    <tr>
                        <td>{{ member_name }}</td>
                        {% for m in monthly_scores %}
                            {% with ms=None %}
                                {% for s in m.scores %}
                                    {% if s.member == member_name %}
                                        {% with ms=s %}
                                            <td class="
                                                {% if ms.score >= 70 %}GREEN
                                                {% elif ms.score >= 50 %}AMBER
                                                {% elif ms.score >= 30 %}RED
                                                {% else %}GREY{% endif %}
                                            ">
                                                {{ ms.score }}
                                            </td>
                                        {% endwith %}
                                    {% endif %}
                                {% empty %}
                                    <td>-</td>
                                {% endfor %}
                            {% endwith %}
                        {% endfor %}
                    </tr>
                    {% endwith %}
                {% endfor %}
            {% else %}
                <tr><td colspan="7">No data available.</td></tr>
            {% endif %}
        </tbody>
    </table>

    <!-- 2️⃣ Averages Table -->
    <h2>Average Scores by Month</h2>
    <table class="averages">
        <thead>
            <tr>
                <th>Month</th>
                <th>Average Score</th>
            </tr>
        </thead>
        <tbody>
            {% for avg in average_scores %}
            <tr>
                <td>{{ avg.month }}</td>
                <td>{{ avg.average_score }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="2">No data available.</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- 3️⃣ Legend -->
    <h2>Color Legend (Overall % of Members)</h2>
    <table class="legend">
        <thead>
            <tr>
                <th>Color</th>
                <th>Count</th>
                <th>Percentage (%)</th>
            </tr>
        </thead>
        <tbody>
            {% for l in legend_data %}
            <tr class="{{ l.color }}">
                <td>{{ l.color }}</td>
                <td>{{ l.count }}</td>
                <td>{{ l.percentage }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="3">No legend data available.</td></tr>
            {% endfor %}
        </tbody>
    </table>

</body>
</html>
