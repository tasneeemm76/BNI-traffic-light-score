<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Members Traffic Lights Scoring</title>
  <style>
    body {
      font-family: "Arial", sans-serif;
      margin: 40px;
      background: #fff;
      color: #000;
    }

    h1 {
      text-align: center;
      color: #b70000;
      font-size: 28px;
      margin-bottom: 20px;
      letter-spacing: 1px;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .header-box {
      flex: 1;
      background: #b70000;
      color: white;
      font-weight: bold;
      text-align: center;
      padding: 6px;
      margin: 0 3px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      margin-bottom: 25px;
    }

    th, td {
      border: 1px solid #000;
      text-align: center;
      padding: 5px 8px;
    }

    th {
      background: #f2f2f2;
      font-weight: bold;
    }

    .member-col {
      text-align: left;
      font-weight: bold;
      width: 180px;
    }

    /* Color classes */
    .GREEN { background-color: #008000; color: #fff; }
    .AMBER { background-color: #FFBF00; color: #000; }
    .RED   { background-color: #ff0000; color: #fff; }
    .GREY  { background-color: #808080; color: #fff; }

    /* Legend and averages */
    .section-title {
      background: #b70000;
      color: #fff;
      font-weight: bold;
      padding: 6px;
      text-align: center;
      margin-top: 25px;
      margin-bottom: 5px;
    }

    .legend-table th {
      background: #b70000;
      color: #fff;
    }
  </style>
</head>
<body>

  <h1>MEMBERS TRAFFIC LIGHTS SCORING</h1>

  <div class="header-row">
    <div class="header-box">Region: {{ region_name }}</div>
    <div class="header-box">{{ chapter_name }}</div>
    <div class="header-box">{{ period_label }}</div>
  </div>

  <!-- === Combined Member vs Month Table === -->
  <div class="section-title">Members Score Per Month</div>
  <table>
    <thead>
      <tr>
        <th>Member</th>
        {% for m in monthly_scores %}
          <th>{{ m.month }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for row in table_rows %}
        <tr>
          <td class="member-col">{{ row.member }}</td>
          {% for m in monthly_scores %}
            {% with s=m.scores|dictsort:"member"|dict_key:row.member %}
            {% endwith %}
            {% for s in m.scores %}
              {% if s.member == row.member %}
                {% if s.score >= 70 %}
                  <td class="GREEN">{{ s.score }}</td>
                {% elif s.score >= 50 %}
                  <td class="AMBER">{{ s.score }}</td>
                {% elif s.score >= 30 %}
                  <td class="RED">{{ s.score }}</td>
                {% else %}
                  <td class="GREY">{{ s.score }}</td>
                {% endif %}
              {% endif %}
            {% endfor %}
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- === Average of Six Months === -->
  <div class="section-title">Average of Six Months</div>
  <table>
    <thead>
      <tr>
        <th>Month</th>
        <th>Average Score</th>
      </tr>
    </thead>
    <tbody>
      {% for a in average_scores %}
        {% if a.average_score >= 70 %}
          <tr class="GREEN">
        {% elif a.average_score >= 50 %}
          <tr class="AMBER">
        {% elif a.average_score >= 30 %}
          <tr class="RED">
        {% else %}
          <tr class="GREY">
        {% endif %}
          <td>{{ a.month }}</td>
          <td>{{ a.average_score }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- === Color Percentage per Month (Legend) === -->
  <div class="section-title">Color Distribution per Month (%)</div>
  <table class="legend-table">
    <thead>
      <tr>
        <th>Color</th>
        {% for m in monthly_scores %}
          <th>{{ m.month }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for color in "GREEN,AMBER,RED,GREY".split(',') %}
        <tr>
          <td class="{{ color }}">{{ color }}</td>
          {% for m in monthly_scores %}
            {% with month_total=m.scores|length %}
              {% with count=0 %}
                {% for s in m.scores %}
                  {% if s.score >= 70 and color == "GREEN" %}
                    {% widthratio 1 month_total 100 as pct %}
                  {% elif s.score >= 50 and s.score < 70 and color == "AMBER" %}
                    {% widthratio 1 month_total 100 as pct %}
                  {% elif s.score >= 30 and s.score < 50 and color == "RED" %}
                    {% widthratio 1 month_total 100 as pct %}
                  {% elif s.score < 30 and color == "GREY" %}
                    {% widthratio 1 month_total 100 as pct %}
                  {% else %}
                    {% widthratio 0 1 0 as pct %}
                  {% endif %}
                {% endfor %}
              {% endwith %}
            {% endwith %}
            <td>-</td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>

</body>
</html>
