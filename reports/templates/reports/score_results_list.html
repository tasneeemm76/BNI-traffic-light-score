{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BNI Traffic Light Tracker – PATRONS</title>

    <style>
        body {
            font-family: "Segoe UI", Arial, sans-serif;
            margin: 40px;
            background: #fff;
            color: #333;
        }

        /* =======================
           GLOBAL TABLE STYLING
        ========================= */
        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 14px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px 12px;
        }

        th {
            background: #b30000;
            color: white;
            font-size: 15px;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 2;
        }

        .member-name {
            font-weight: bold;
            text-align: left;
            background: #f7f7f7;
        }

        td.colored {
            color: white;
            font-weight: bold;
        }

        /* =======================
           HEADER BAR
        ========================= */
        .main-heading {
            text-align: center;
            font-size: 32px;
            font-weight: bold;
            color: #b30000;
            margin-bottom: 10px;
        }

        .header-bar {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 35px;
        }

        .header-box {
            background-color: #b30000;
            color: white;
            padding: 10px 25px;
            font-weight: bold;
            font-size: 16px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.18);
        }

        /* =======================
           FILE UPLOAD UI
        ========================= */
        .upload-container {
            background: #fafafa;
            padding: 25px;
            border: 2px solid #b30000;
            border-radius: 6px;
            margin-bottom: 30px;
        }

        .upload-container input {
            margin: 10px 0 15px 0;
        }

        .upload-btn {
            padding: 10px 25px;
            background: #b30000;
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .upload-btn:hover {
            background: #7a0000;
        }

        /* ======================
           PREVIEW TABLE
        ====================== */
        .preview-table {
            width: 50%;
            margin-top: 20px;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0px 2px 6px rgba(0,0,0,0.15);
        }

        /* ======================
           MONTHS LIST
        ====================== */
        .month-list {
            padding: 18px;
            background: #f8f8f8;
            border-left: 4px solid #b30000;
            margin: 35px 0 15px 0;
            font-size: 15px;
            line-height: 1.7;
        }

        .month-list a {
            cursor: pointer;
            font-weight: bold;
            color: #b30000;
            text-decoration: underline;
        }

        .month-list a:hover {
            color: #000;
        }

        /* ======================
           MEMBER ANALYSIS BUTTON
        ====================== */
        .analysis-btn {
            display: inline-block;
            background: #b30000;
            color: white !important;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 15px;
            font-weight: bold;
            letter-spacing: 0.5px;
            text-decoration: none;
            margin: 15px 0 30px 0;
            box-shadow: 0 3px 6px rgba(0,0,0,0.22);
            transition: 0.2s;
        }

        .analysis-btn:hover {
            background: #7a0000;
        }

        /* ======================
           DRILLDOWN SECTION
        ====================== */
        .drill-row {
            display: none;
        }

        .drill-box {
            margin: 12px 0 25px 0;
            padding: 22px;
            border: 2px solid #b30000;
            border-radius: 4px;
            background: #ffffff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.12);
        }

        .sub-table th {
            background: #333;
        }

        /* ======================
           LEGEND
        ====================== */
        .legend {
            margin-top: 35px;
            display: flex;
            justify-content: center;
            gap: 30px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
        }

        .box {
            width: 22px;
            height: 22px;
            border-radius: 4px;
            border: 1px solid #777;
        }
    </style>




    <script>
        function toggleDrillBySlug(slug) {
            var row = document.getElementById("drill_" + slug);
            if (!row) return;
            row.style.display = (row.style.display === "table-row") ? "none" : "table-row";
            if (row.style.display === "table-row") {
                row.scrollIntoView({ behavior: "smooth" });
            }
        }
    </script>

</head>
<body>

<h1 class="main-heading">BNI Traffic Light Tracker – PATRONS</h1>

<div class="header-bar">
    <div class="header-box">Region: Delhi Central</div>
    <div class="header-box">PATRONS</div>
    <div class="header-box">Summary</div>
</div>

{% if error %}
    <p style="text-align:center; color:red; font-weight:bold;">{{ error }}</p>
{% else %}

<!-- UPLOAD SECTION -->
<div class="upload-container">
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <label><b>Upload Data:</b></label><br>
        <input type="file" name="file" required><br>

        <label><b>Training File (optional):</b></label><br>
        <input type="file" name="training_file"><br>

        <button type="submit" class="upload-btn">Preview</button>
    </form>
</div>


<!-- PREVIEW RESULTS -->
{% if preview_results %}
    <h2 style="margin-top:20px;">Preview Results (Not Saved)</h2>

    <p>
        <b>From:</b> {{ preview_start }} &nbsp;&nbsp;&nbsp;
        <b>To:</b> {{ preview_end }} &nbsp;&nbsp;&nbsp;
        <b>Weeks:</b> {{ preview_weeks }}
    </p>

    <table class="preview-table">
        <tr>
            <th>Member</th>
            <th>Total Score</th>
        </tr>

        {% for r in preview_results %}
        <tr>
            <td>{{ r.name }}</td>
            <td style="background:{{ r.color }}; color:white; font-weight:bold;">
                {{ r.total }}
            </td>
        </tr>
        {% endfor %}
    </table>

    <hr style="margin:40px 0;">
{% endif %}


<!-- MONTH LIST -->
<div class="month-list">
    <strong>View Month Summary:</strong><br>
    {% for block in drilldown_list %}
        <a onclick="toggleDrillBySlug('{{ block.slug }}')">{{ block.month }}</a><br>
    {% endfor %}
</div>


<!-- MEMBER ANALYSIS BUTTON -->
<div>
    <a href="{% url 'member_analysis' %}" class="analysis-btn">
        View Member Analysis →
    </a>
</div>


<!-- HEATMAP -->
<table>
    <thead>
        <tr>
            <th>Member</th>
            {% for block in drilldown_list %}
                <th onclick="toggleDrillBySlug('{{ block.slug }}')" style="cursor:pointer;">
                    {{ block.month }}
                </th>
            {% endfor %}
        </tr>
    </thead>

    <tbody>
        {% for row in table_data %}
        <tr>
            <td class="member-name">{{ row.member }}</td>
            {% for cell in row.scores %}
                <td class="colored" style="background: {{ cell.color }};">
                    {{ cell.value }}
                </td>
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>


<!-- DRILLDOWN SECTIONS -->
{% for block in drilldown_list %}
<table>
    <tr id="drill_{{ block.slug }}" class="drill-row">
        <td colspan="{{ drilldown_list|length|add:1 }}">
            <div class="drill-box">
                <h3>Detailed Scores – {{ block.month }}</h3>

                <table class="sub-table">
                    <thead>
                        <tr>
                            <th>Member</th>
                            <th>Training</th>
                            <th>Absent</th>
                            <th>Referrals</th>
                            <th>TYFCB</th>
                            <th>Visitors</th>
                            <th>Testimonials</th>
                            <th>On Time</th>
                            <th>Total</th>
                        </tr>
                    </thead>

                    <tbody>
                        {% for r in block.rows %}
                        <tr>
                            <td>{{ r.name }}</td>
                            <td>{{ r.training }}</td>
                            <td>{{ r.absent }}</td>
                            <td>{{ r.ref }}</td>
                            <td>{{ r.tyfcb }}</td>
                            <td>{{ r.visitors }}</td>
                            <td>{{ r.testimonials }}</td>
                            <td>{{ r.on_time }}</td>
                            <td style="background:{{ r.total_color }}; color:white; font-weight:bold;">
                                {{ r.total }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>

                </table>
            </div>
        </td>
    </tr>
</table>
{% endfor %}


<!-- LEGEND -->
<div class="legend">
    <div class="legend-item"><div class="box" style="background:#008000"></div> ≥70</div>
    <div class="legend-item"><div class="box" style="background:#FFBF00"></div> 50–69</div>
    <div class="legend-item"><div class="box" style="background:#ff0000"></div> 30–49</div>
    <div class="legend-item"><div class="box" style="background:#808080"></div> &lt;30</div>
</div>


{% endif %}

</body>
</html>
