{% load static %}

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Tasneem Bawaji</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: white;
            margin: 20px 420px 40px 20px;   /* ✅ Leaves space for scoring box */
            color: #000;
        }

        h2 {
            margin-top: 40px;
            font-size: 22px;
            font-weight: bold;
            border-bottom: 2px solid #b30000;
            padding-bottom: 6px;
            width: fit-content;
        }

        /* ------------------ TABLE ------------------ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            margin-bottom: 50px;
            font-size: 14px;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 8px 10px;
            text-align: center;
        }

        th {
            background: #b30000;
            color: white;
            font-weight: bold;
        }

        .metric-cell {
            font-weight: bold;
            background: #e8e8e8;
        }

        td.total-cell {
            background: #222;
            color: white;
            font-weight: bold;
        }

        /* ------------------ GRAPH ------------------ */
        .chart-container {
            width: 100%;
            height: 270px;
            margin-bottom: 25px;
        }

        /* ------------------ FIXED SCORING BOX ------------------ */
        .scoring-fixed {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 360px;
            max-height: 95vh;
            overflow-y: auto;
            background: white;
            border: 3px solid #b30000;
            padding: 10px 15px;
            z-index: 9999;
        }

        .scoring-fixed h3 {
            background: #b30000;
            color: white;
            text-align: center;
            padding: 8px;
            margin: 0 0 15px 0;
            font-size: 18px;
            letter-spacing: .5px;
        }

        .rules-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .rule-card {
            border: 1px solid #888;
            width: 48%;
            background: #f9f9f9;
        }

        .rule-card h4 {
            background: #b30000;
            color: white;
            padding: 4px;
            margin: 0;
            text-align: center;
            font-size: 13px;
        }

        .rule-card table {
            width: 100%;
            border-collapse: collapse;
        }

        .rule-card td {
            border: 1px solid #ccc;
            text-align: center;
            font-size: 12px;
            padding: 3px;
        }

        /* Color Blocks */
        .green { background:#6cc070; font-weight: bold; }
        .yellow { background:#f5c542; font-weight: bold; }
        .orange { background:#ff9900; font-weight: bold; }
        .red { background:#e84c3d; font-weight: bold; }
        .grey { background:#d3d3d3; font-weight: bold; }

        .legend-box {
            width: 20px; height: 20px;
            border: 1px solid #555;
        }

          .header-bar {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 40px; /* spacing between boxes */
    margin: 20px 0;
}

.header-box {
    background-color: #b30000; /* red background */
    color: white;
    padding: 8px 20px;
    font-family: Arial, sans-serif;
    font-weight: bold;
    font-size: 16px;
    border-radius: 2px;
    text-align: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}


    </style>
</head>

<body>
    <div class="header-bar">
    <div class="header-box">Region: Delhi Central</div>
    <div class="header-box">PATRONS</div>
</div>

<form method="get" style="margin-bottom:20px;">
    <label><b>Select Member:</b></label>
    <select name="member" onchange="this.form.submit()">
        <option value="">-- Select Member --</option>
        {% for m in member_names %}
            <option value="{{ m }}" {% if m == selected_member %}selected{% endif %}>{{ m }}</option>
        {% endfor %}
    </select>
</form>

{% if not selected_member %}
    <p style="font-size:16px; margin-top:20px;"><b>Please select a member to view the report.</b></p>
{% endif %}


<!-- ✅ FIXED SCORING BOX -->
<div class="scoring-fixed">
    <h3>Scoring</h3>

    <style>
        .green { background:#008000; color:white; font-weight:bold; }
        .amber { background:#FFBF00; font-weight:bold; }
        .red { background:#ff0000; color:white; font-weight:bold; }
        .grey { background:#808080; color:white; font-weight:bold; }
    </style>

    <!-- ✅ ROW 1: REFERRALS + VISITORS -->
    <div class="rules-row">
        <div class="rule-card">
            <h4>Referrals / Week</h4>
            <table>
                <tr><td>&lt; 0.5</td><td class="grey">0</td></tr>
                <tr><td>&lt; 0.75</td><td class="grey">5</td></tr>
                <tr><td>&lt; 1</td><td class="red">10</td></tr>
                <tr><td>&lt; 1.2</td><td class="amber">15</td></tr>
                <tr><td>≥ 1.2</td><td class="green">20</td></tr>
            </table>
        </div>

        <div class="rule-card">
            <h4>Avg Visitor / Week</h4>
            <table>
                <tr><td>&lt; 0.1</td><td class="grey">0</td></tr>
                <tr><td>&lt; 0.25</td><td class="red">5</td></tr>
                <tr><td>&lt; 0.5</td><td class="amber">10</td></tr>
                <tr><td>&lt; 0.75</td><td class="green">15</td></tr>
                <tr><td>≥ 0.75</td><td class="green">20</td></tr>
            </table>
        </div>
    </div>

    <!-- ✅ ROW 2: ABSENTEEISM + TYFCB -->
    <div class="rules-row">
        <div class="rule-card">
            <h4>Absenteeism</h4>
            <table>
                <tr><td>&gt; 2</td><td class="grey">0</td></tr>
                <tr><td>= 2</td><td class="red">5</td></tr>
                <tr><td>= 1</td><td class="red">10</td></tr>
                <tr><td>&lt; 1</td><td class="green">15</td></tr>
            </table>
        </div>

        <div class="rule-card">
            <h4>TYFCB</h4>
            <table>
                <tr><td>&lt; 500000</td><td class="green">0</td></tr>
                <tr><td>&lt; 1000000</td><td class="red">5</td></tr>
                <tr><td>&lt; 2000000</td><td class="amber">10</td></tr>
                <tr><td>≥ 2000000</td><td class="green">15</td></tr>
            </table>
        </div>
    </div>

    <!-- ✅ ROW 3: TRAINING + TESTIMONIALS -->
    <div class="rules-row">
        <div class="rule-card">
            <h4>Training</h4>
            <table>
                <tr><td>= 0</td><td class="grey">0</td></tr>
                <tr><td>= 1</td><td class="red">5</td></tr>
                <tr><td>= 2</td><td class="amber">10</td></tr>
                <tr><td>≥ 3</td><td class="green">15</td></tr>
            </table>
        </div>

        <div class="rule-card">
            <h4>Testimonials / Week</h4>
            <table>
                <tr><td>≤ 0</td><td class="red">0</td></tr>
                <tr><td>&lt; 0.075</td><td class="amber">5</td></tr>
                <tr><td>≥ 0.075</td><td class="green">10</td></tr>
            </table>
        </div>
    </div>

    <!-- ✅ ROW 4: ON TIME + LEGEND -->
    <div class="rules-row">
        <div class="rule-card">
            <h4>Arriving On Time</h4>
            <table>
                <tr><td>Late ≥ 1</td><td class="red">0</td></tr>
                <tr><td>No Late</td><td class="green">5</td></tr>
            </table>
        </div>

        <div class="rule-card">
            <h4>Total Score Legend</h4>
            <table>
                <tr><td class="green legend-box"></td><td>≥ 70</td></tr>
                <tr><td class="amber legend-box"></td><td>50–69</td></tr>
                <tr><td class="red legend-box"></td><td>30–49</td></tr>
                <tr><td class="grey legend-box"></td><td>&lt; 30</td></tr>
            </table>
        </div>
    </div>

</div>


{% if error %}
<p style="color:red; text-align:center;">{{ error }}</p>
{% endif %}

<!-- ✅ MEMBER SECTIONS -->
{% for member, records in members %}

    <h2>{{ member }}</h2>

    <!-- GRAPH -->
    <div class="chart-container">
        <canvas id="chart_{{ forloop.counter }}"></canvas>
    </div>

    <script>
        const ctx{{ forloop.counter }} = document
            .getElementById("chart_{{ forloop.counter }}")
            .getContext("2d");

        new Chart(ctx{{ forloop.counter }}, {
            type: 'line',
            data: {
                labels: [{% for r in records %}"{{ r.period }}",{% endfor %}],
                datasets: [{
                    label: "Total Score",
                    data: [{% for r in records %}{{ r.total }},{% endfor %}],
                    borderWidth: 3,
                    pointRadius: 5,
                    borderColor: "#b30000",
                    backgroundColor: "#b30000",
                    tension: 0.3
                }]
            },
            options: {
                scales: { y: { min: 0, max: 100 } }
            }
        });
    </script>

    <!-- TABLE -->
    <table>
        <thead>
        <tr>
            <th>Period</th>
            <th>Absent<br>(15)</th>
            <th>Referrals<br>(20)</th>
            <th>TYFTB<br>(15)</th>
            <th>Visitors<br>(20)</th>
            <th>Testimonials<br>(10)</th>
            <th>On Time<br>(5)</th>
            <th>Training<br>(15)</th>
            <th>Total</th>
        </tr>
        </thead>

        <tbody>
        {% for r in records %}
        <tr>
            <td><b>{{ r.period }}</b></td>
            <td class="metric-cell">{{ r.absent.value }}</td>
            <td class="metric-cell">{{ r.referrals.value }}</td>
            <td class="metric-cell">{{ r.tyfcb.value }}</td>
            <td class="metric-cell">{{ r.visitors.value }}</td>
            <td class="metric-cell">{{ r.testimonials.value }}</td>
            <td class="metric-cell">{{ r.on_time.value }}</td>
            <td class="metric-cell">{{ r.training.value }}</td>
<td class="total-cell" style="background: {{ r.color }}; color: white;">
    {{ r.total }}
</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>

   {% if suggestions %}
<div style="margin-top:30px; padding:20px; border:2px solid #b30000; border-radius:6px;">
    <h3 style="margin-bottom:15px; font-size:20px; color:#b30000;">
        How Can You Increase Your Score?
    </h3>

    <ul style="font-size:16px; line-height:1.6;">
        {% for s in suggestions %}
            <li>{{ s }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{% endfor %}

</body>
</html>
